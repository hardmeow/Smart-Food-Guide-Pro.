<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºé£Ÿé‰´ Pro - é£Ÿå“å¥åº·åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #10B981;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, #F0FDF4 100%);
            color: #1F2937;
        }
        body.dark { background: linear-gradient(135deg, var(--gray-900) 0%, #0F172A 100%); color: #E5E7EB; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid var(--gray-200); }
        body.dark .header { border-bottom-color: var(--gray-700); }
        h1 { font-size: 24px; font-weight: 700; background: linear-gradient(135deg, var(--primary) 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #059669 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }
        .btn-secondary { background: var(--gray-200); color: #1F2937; }
        body.dark .btn-secondary { background: var(--gray-700); color: #E5E7EB; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .card { background: white; border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        body.dark .card { background: var(--gray-800); box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .upload-area { border: 2px dashed var(--primary); border-radius: 12px; padding: 40px 20px; text-align: center; background: linear-gradient(135deg, #ECFDF5 0%, #F0FDF4 100%); cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { background: #D1FAE5; border-color: #059669; }
        .upload-area.drag-over { background: #A7F3D0; border-color: #059669; }
        input[type="file"] { display: none; }
        .tabs { display: flex; gap: 8px; border-bottom: 2px solid var(--gray-200); margin: 20px 0; }
        body.dark .tabs { border-bottom-color: var(--gray-700); }
        .tab { padding: 12px 20px; background: none; border: none; cursor: pointer; font-weight: 600; color: #6B7280; border-bottom: 3px solid transparent; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        body.dark .modal-content { background: var(--gray-800); }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--gray-300); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-bar { width: 100%; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden; margin: 12px 0; }
        body.dark .progress-bar { background: var(--gray-700); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, #059669 100%); transition: width 0.3s; }
        .hidden { display: none !important; }
        video { width: 100%; height: auto; aspect-ratio: 4/3; object-fit: cover; border-radius: 8px; }
        canvas { max-width: 100%; border-radius: 8px; }
        img { max-width: 100%; border-radius: 8px; }
        .flex { display: flex; gap: 12px; }
        .flex-col { flex-direction: column; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .ingredient-tag { display: inline-block; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin: 4px; cursor: pointer; }
        .risk-0, .risk-1 { background: #ECFDF5; color: #059669; }
        .risk-2, .risk-3 { background: #FFFBEB; color: #B45309; }
        .risk-4, .risk-5 { background: #FEE2E2; color: #DC2626; }
        .alert { padding: 12px 16px; border-radius: 8px; margin: 12px 0; border-left: 4px solid; }
        .alert-danger { background: #FEE2E2; border-left-color: #EF4444; color: #DC2626; }
        .alert-success { background: #ECFDF5; border-left-color: var(--primary); color: #059669; }
        .alert-warning { background: #FEF3C7; border-left-color: #F59E0B; color: #B45309; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; margin-bottom: 12px; }
        body.dark input[type="text"], body.dark input[type="password"], body.dark textarea { background: var(--gray-700); border-color: var(--gray-600); color: #E5E7EB; }
        .crop-container { position: relative; display: inline-block; width: 100%; }
        .crop-image { width: 100%; cursor: crosshair; }
        .crop-box { position: absolute; border: 2px solid var(--primary); background: rgba(16, 185, 129, 0.1); }
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .header { padding: 12px 0; }
            h1 { font-size: 20px; }
            .card { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ æ™ºé£Ÿé‰´ Pro</h1>
            <div>
                <button class="btn btn-secondary" id="themeBtn" style="margin-right: 8px;">ğŸŒ™</button>
                <button class="btn btn-secondary" id="settingsBtn">âš™ï¸</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="scan">ğŸ“¸ æ‰«æ</button>
            <button class="tab" data-tab="history">ğŸ“‹ å†å²</button>
        </div>

        <!-- æ‰«æé¡µé¢ -->
        <div id="scan-tab" class="tab-content active">
            <div id="uploadSection" class="card">
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“¸</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½å›¾ç‰‡</div>
                    <div style="font-size: 12px; color: #6B7280;">æ”¯æŒ JPGã€PNG ç­‰æ ¼å¼</div>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                <div class="flex" style="margin-top: 12px;">
                    <button class="btn btn-primary" id="cameraBtn" style="flex: 1;">ğŸ“· æ‰“å¼€ç›¸æœº</button>
                    <button class="btn btn-primary" id="scanBarcodeBtn" style="flex: 1;">ğŸ“Š æ‰«ç </button>
                </div>
            </div>

            <!-- ç›¸æœº -->
            <div id="cameraSection" class="card hidden">
                <video id="cameraVideo" playsinline></video>
                <div class="flex" style="margin-top: 12px;">
                    <button class="btn btn-secondary" id="switchCameraBtn" style="flex: 1;">ğŸ”„ åˆ‡æ¢</button>
                    <button class="btn btn-primary" id="captureBtn" style="flex: 1;">ğŸ“· æ‹ç…§</button>
                    <button class="btn btn-secondary" id="closeCameraBtn" style="flex: 1;">âœ•</button>
                </div>
            </div>

            <!-- æ‰«ç  -->
            <div id="barcodeSection" class="card hidden">
                <video id="barcodeVideo" playsinline style="width: 100%; margin-bottom: 12px;"></video>
                <div class="flex">
                    <button class="btn btn-secondary" id="closeBarcodeBtn" style="flex: 1;">âœ• å…³é—­</button>
                </div>
            </div>

            <!-- é¢„è§ˆ -->
            <div id="previewSection" class="card hidden">
                <img id="previewImage" style="width: 100%; max-height: 300px; object-fit: cover; margin-bottom: 12px;">
                <div class="flex">
                    <button class="btn btn-secondary" id="rotateBtn" style="flex: 1;">ğŸ”„ æ—‹è½¬</button>
                    <button class="btn btn-secondary" id="cropBtn" style="flex: 1;">âœ‚ï¸ è£å‰ª</button>
                    <button class="btn btn-secondary" id="changeImageBtn" style="flex: 1;">æ›´æ¢</button>
                    <button class="btn btn-primary" id="analyzeBtn" style="flex: 1;">ğŸš€ åˆ†æ</button>
                </div>
            </div>

            <!-- è£å‰ª -->
            <div id="cropSection" class="card hidden">
                <div class="crop-container">
                    <img id="cropImage" class="crop-image" style="width: 100%; cursor: crosshair;">
                    <div id="cropBox" class="crop-box hidden"></div>
                </div>
                <div class="flex" style="margin-top: 12px;">
                    <button class="btn btn-secondary" id="cancelCropBtn" style="flex: 1;">å–æ¶ˆ</button>
                    <button class="btn btn-primary" id="confirmCropBtn" style="flex: 1;">âœ“ ç¡®è®¤</button>
                </div>
            </div>

            <!-- åŠ è½½ä¸­ -->
            <div id="loadingSection" class="card hidden text-center">
                <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 16px;"></div>
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">æ­£åœ¨åˆ†æ...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                <div id="loadingStatus" style="font-size: 12px; color: #6B7280; margin-top: 8px;">åˆå§‹åŒ–ä¸­...</div>
                <button class="btn btn-secondary" id="cancelBtn" style="margin-top: 12px;">å–æ¶ˆ</button>
            </div>

            <!-- ç»“æœ -->
            <div id="resultsSection" class="hidden">
                <div class="card">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">ğŸ¯ å¥åº·è¯„åˆ†</div>
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 48px; font-weight: 700; color: var(--primary);" id="scoreNumber">0</div>
                        <div style="font-size: 14px; color: #6B7280;" id="scoreLevel">ä¼˜ç§€</div>
                    </div>
                </div>

                <div class="card">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">ğŸ§ª é…æ–™æˆåˆ†</div>
                    <div id="ingredientsList" style="display: flex; flex-wrap: wrap;"></div>
                </div>

                <div class="card">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">ğŸ“Š è¥å…»æˆåˆ†</div>
                    <div id="nutritionGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;"></div>
                </div>

                <div class="card">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">ğŸ’¡ å»ºè®®</div>
                    <ul id="adviceList" style="list-style: none;"></ul>
                </div>

                <div class="flex">
                    <button class="btn btn-secondary" id="resetBtn" style="flex: 1;">ğŸ”„ é‡æ–°æ‰«æ</button>
                    <button class="btn btn-secondary" id="shareBtn" style="flex: 1;">ğŸ“„ åˆ†äº«</button>
                </div>
            </div>

            <!-- é”™è¯¯ -->
            <div id="errorSection" class="card hidden">
                <div class="alert alert-danger">âš ï¸ <span id="errorMessage"></span></div>
                <button class="btn btn-secondary w-full" id="retryBtn">é‡è¯•</button>
            </div>
        </div>

        <!-- å†å²é¡µé¢ -->
        <div id="history-tab" class="tab-content">
            <div class="card">
                <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">ğŸ“‹ æ‰«æå†å²</div>
                <input type="text" id="historySearch" placeholder="æœç´¢...">
                <ul id="historyList" style="list-style: none;"></ul>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">âš™ï¸ è®¾ç½®</div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px;">DeepSeek API Key</label>
            <input type="password" id="apiKeyInput" placeholder="sk-xxxxxxxxxxxxxxxx">
            <div style="font-size: 12px; color: #6B7280; margin-bottom: 12px;">æ ¼å¼: sk-å¼€å¤´ï¼Œè‡³å°‘ 20 ä¸ªå­—ç¬¦</div>
            <button class="btn btn-primary w-full" id="saveApiKeyBtn">ä¿å­˜</button>
            <button class="btn btn-secondary w-full" id="closeSettingsBtn" style="margin-top: 8px;">å…³é—­</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            API_URL: 'https://api.deepseek.com/v1/chat/completions',
            MODEL: 'deepseek-chat',
            API_TIMEOUT: 30000,
            MAX_RETRIES: 3,
            MAX_IMAGE_SIZE: 5 * 1024 * 1024,
            IMAGE_QUALITY: 0.8,
            IMAGE_MAX_WIDTH: 1024,
            IMAGE_MAX_HEIGHT: 1024
        };

        const app = {
            apiKey: '',
            history: [],
            currentImage: null,
            currentAnalysis: null,
            cameraStream: null,
            barcodeStream: null,
            facingMode: 'environment',
            isAnalyzing: false,
            cropData: null,
            rotation: 0,

            init() {
                this.loadData();
                this.bindEvents();
                this.renderHistory();
            },

            loadData() {
                this.apiKey = localStorage.getItem('apiKey') || '';
                this.history = JSON.parse(localStorage.getItem('history') || '[]');
                const theme = localStorage.getItem('theme') || 'light';
                if (theme === 'dark') document.body.classList.add('dark');
            },

            saveData() {
                localStorage.setItem('apiKey', this.apiKey);
                localStorage.setItem('history', JSON.stringify(this.history));
            },

            bindEvents() {
                // ä¸»é¢˜
                document.getElementById('themeBtn').addEventListener('click', () => {
                    document.body.classList.toggle('dark');
                    localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
                });

                // æ ‡ç­¾é¡µ
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                        if (tab.dataset.tab === 'history') this.renderHistory();
                    });
                });

                // æ‹–æ”¾ä¸Šä¼ 
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.handleImageFile(file);
                    }
                });

                // ä¸Šä¼ 
                uploadArea.addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });

                document.getElementById('fileInput').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) this.handleImageFile(file);
                });

                // ç›¸æœº
                document.getElementById('cameraBtn').addEventListener('click', () => this.startCamera());
                document.getElementById('captureBtn').addEventListener('click', () => this.capturePhoto());
                document.getElementById('switchCameraBtn').addEventListener('click', () => this.switchCamera());
                document.getElementById('closeCameraBtn').addEventListener('click', () => this.stopCamera());

                // æ‰«ç 
                document.getElementById('scanBarcodeBtn').addEventListener('click', () => this.startBarcode());
                document.getElementById('closeBarcodeBtn').addEventListener('click', () => this.stopBarcode());

                // æ—‹è½¬
                document.getElementById('rotateBtn').addEventListener('click', () => this.rotateImage());

                // è£å‰ª
                document.getElementById('cropBtn').addEventListener('click', () => this.startCrop());
                document.getElementById('cancelCropBtn').addEventListener('click', () => this.cancelCrop());
                document.getElementById('confirmCropBtn').addEventListener('click', () => this.confirmCrop());

                // åˆ†æ
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyze());
                document.getElementById('changeImageBtn').addEventListener('click', () => {
                    document.getElementById('previewSection').classList.add('hidden');
                    document.getElementById('uploadSection').classList.remove('hidden');
                });

                // ç»“æœ
                document.getElementById('resetBtn').addEventListener('click', () => {
                    document.getElementById('resultsSection').classList.add('hidden');
                    document.getElementById('uploadSection').classList.remove('hidden');
                    this.currentImage = null;
                    this.rotation = 0;
                });

                document.getElementById('shareBtn').addEventListener('click', () => this.share());
                document.getElementById('retryBtn').addEventListener('click', () => this.analyze());
                document.getElementById('cancelBtn').addEventListener('click', () => this.cancelAnalysis());

                // è®¾ç½®
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    document.getElementById('apiKeyInput').value = this.apiKey;
                    document.getElementById('settingsModal').classList.add('active');
                });

                document.getElementById('saveApiKeyBtn').addEventListener('click', () => {
                    const key = document.getElementById('apiKeyInput').value.trim();
                    if (!this.validateApiKey(key)) {
                        alert('âŒ API Key æ ¼å¼é”™è¯¯ï¼Œåº”ä»¥ sk- å¼€å¤´');
                        return;
                    }
                    this.apiKey = key;
                    this.saveData();
                    alert('âœ… API Key å·²ä¿å­˜');
                    document.getElementById('settingsModal').classList.remove('active');
                });

                document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.remove('active');
                });

                // å†å²æœç´¢
                document.getElementById('historySearch').addEventListener('input', () => this.renderHistory());

                // æ¨¡æ€æ¡†å…³é—­
                document.getElementById('settingsModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('settingsModal')) {
                        document.getElementById('settingsModal').classList.remove('active');
                    }
                });
            },

            validateApiKey(key) {
                return /^sk-[a-zA-Z0-9]{20,}$/.test(key);
            },

            handleImageFile(file) {
                if (file.size > CONFIG.MAX_IMAGE_SIZE) {
                    alert('âŒ å›¾ç‰‡è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 5MB çš„å›¾ç‰‡');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentImage = e.target.result;
                    this.rotation = 0;
                    this.showPreview();
                };
                reader.readAsDataURL(file);
            },

            showPreview() {
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('previewSection').classList.remove('hidden');
                document.getElementById('previewImage').src = this.currentImage;
            },

            async startCamera() {
                try {
                    document.getElementById('uploadSection').classList.add('hidden');
                    document.getElementById('cameraSection').classList.remove('hidden');
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: this.facingMode }
                    });
                    this.cameraStream = stream;
                    document.getElementById('cameraVideo').srcObject = stream;
                } catch (e) {
                    alert('âŒ æ— æ³•è®¿é—®ç›¸æœº: ' + e.message);
                    document.getElementById('cameraSection').classList.add('hidden');
                    document.getElementById('uploadSection').classList.remove('hidden');
                }
            },

            capturePhoto() {
                const video = document.getElementById('cameraVideo');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.currentImage = e.target.result;
                        this.rotation = 0;
                        this.stopCamera();
                        this.showPreview();
                    };
                    reader.readAsDataURL(blob);
                });
            },

            switchCamera() {
                this.facingMode = this.facingMode === 'environment' ? 'user' : 'environment';
                this.stopCamera();
                this.startCamera();
            },

            stopCamera() {
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(t => t.stop());
                    this.cameraStream = null;
                }
                document.getElementById('cameraSection').classList.add('hidden');
                document.getElementById('uploadSection').classList.remove('hidden');
            },

            async startBarcode() {
                try {
                    document.getElementById('uploadSection').classList.add('hidden');
                    document.getElementById('barcodeSection').classList.remove('hidden');
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });
                    this.barcodeStream = stream;
                    document.getElementById('barcodeVideo').srcObject = stream;
                    this.scanBarcode();
                } catch (e) {
                    alert('âŒ æ— æ³•è®¿é—®ç›¸æœº: ' + e.message);
                    document.getElementById('barcodeSection').classList.add('hidden');
                    document.getElementById('uploadSection').classList.remove('hidden');
                }
            },

            async scanBarcode() {
                const video = document.getElementById('barcodeVideo');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const codeReader = new ZXing.BrowserMultiFormatReader();

                const scanInterval = setInterval(async () => {
                    if (!this.barcodeStream) {
                        clearInterval(scanInterval);
                        return;
                    }
                    try {
                        const result = await codeReader.decodeFromVideoElement(video);
                        if (result) {
                            clearInterval(scanInterval);
                            this.stopBarcode();
                            alert('âœ… æ‰«ç æˆåŠŸ: ' + result.text);
                            // è¿™é‡Œå¯ä»¥è°ƒç”¨ API æŸ¥è¯¢æ¡ç å¯¹åº”çš„é£Ÿå“ä¿¡æ¯
                        }
                    } catch (e) {
                        // ç»§ç»­æ‰«æ
                    }
                }, 500);
            },

            stopBarcode() {
                if (this.barcodeStream) {
                    this.barcodeStream.getTracks().forEach(t => t.stop());
                    this.barcodeStream = null;
                }
                document.getElementById('barcodeSection').classList.add('hidden');
                document.getElementById('uploadSection').classList.remove('hidden');
            },

            rotateImage() {
                this.rotation = (this.rotation + 90) % 360;
                const img = document.getElementById('previewImage');
                img.style.transform = `rotate(${this.rotation}deg)`;
            },

            startCrop() {
                document.getElementById('previewSection').classList.add('hidden');
                document.getElementById('cropSection').classList.remove('hidden');
                const img = document.getElementById('cropImage');
                img.src = this.currentImage;
                img.style.transform = `rotate(${this.rotation}deg)`;

                let startX, startY, isDrawing = false;
                const cropBox = document.getElementById('cropBox');

                img.addEventListener('mousedown', (e) => {
                    isDrawing = true;
                    const rect = img.getBoundingClientRect();
                    startX = e.clientX - rect.left;
                    startY = e.clientY - rect.top;
                });

                img.addEventListener('mousemove', (e) => {
                    if (!isDrawing) return;
                    const rect = img.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    cropBox.classList.remove('hidden');
                    cropBox.style.left = Math.min(startX, x) + 'px';
                    cropBox.style.top = Math.min(startY, y) + 'px';
                    cropBox.style.width = Math.abs(x - startX) + 'px';
                    cropBox.style.height = Math.abs(y - startY) + 'px';
                });

                img.addEventListener('mouseup', () => {
                    isDrawing = false;
                    this.cropData = {
                        x: parseInt(cropBox.style.left),
                        y: parseInt(cropBox.style.top),
                        width: parseInt(cropBox.style.width),
                        height: parseInt(cropBox.style.height)
                    };
                });
            },

            cancelCrop() {
                document.getElementById('cropSection').classList.add('hidden');
                document.getElementById('previewSection').classList.remove('hidden');
                document.getElementById('cropBox').classList.add('hidden');
            },

            confirmCrop() {
                if (!this.cropData || this.cropData.width < 10 || this.cropData.height < 10) {
                    alert('âŒ è¯·é€‰æ‹©æœ‰æ•ˆçš„è£å‰ªåŒºåŸŸ');
                    return;
                }
                const canvas = document.createElement('canvas');
                const img = new Image();
                img.onload = () => {
                    canvas.width = this.cropData.width;
                    canvas.height = this.cropData.height;
                    canvas.getContext('2d').drawImage(img, -this.cropData.x, -this.cropData.y);
                    canvas.toBlob((blob) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.currentImage = e.target.result;
                            this.cancelCrop();
                            this.showPreview();
                        };
                        reader.readAsDataURL(blob);
                    });
                };
                img.src = this.currentImage;
            },

            updateProgress(percent, text) {
                document.getElementById('progressFill').style.width = percent + '%';
                document.getElementById('loadingStatus').textContent = text;
            },

            cancelAnalysis() {
                this.isAnalyzing = false;
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('previewSection').classList.remove('hidden');
            },

            async analyze() {
                if (!this.currentImage) return;
                if (!this.apiKey) {
                    alert('âŒ è¯·å…ˆé…ç½® API Key');
                    return;
                }
                if (!this.validateApiKey(this.apiKey)) {
                    alert('âŒ API Key æ ¼å¼é”™è¯¯');
                    return;
                }

                this.isAnalyzing = true;
                document.getElementById('previewSection').classList.add('hidden');
                document.getElementById('loadingSection').classList.remove('hidden');
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('errorSection').classList.add('hidden');

                try {
                    this.updateProgress(10, 'å‹ç¼©å›¾ç‰‡...');
                    const compressedImage = await this.compressImage(this.currentImage);

                    this.updateProgress(20, 'åˆå§‹åŒ– OCR...');
                    const worker = await Tesseract.createWorker('chi_sim');

                    this.updateProgress(40, 'è¯†åˆ«æ–‡å­—ä¸­...');
                    const result = await worker.recognize(compressedImage);
                    let text = result.data.text.trim();
                    await worker.terminate();

                    if (!text || text.length < 10) {
                        throw new Error('OCR è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–ä¸Šä¼ æ›´æ¸…æ™°çš„å›¾ç‰‡');
                    }

                    this.updateProgress(70, 'è°ƒç”¨ AI åˆ†æ...');
                    const analysis = await this.callAPI(text);

                    this.updateProgress(100, 'å®Œæˆ');
                    if (this.isAnalyzing) {
                        setTimeout(() => this.showResults(analysis), 500);
                    }
                } catch (e) {
                    if (this.isAnalyzing) {
                        this.showError(e.message);
                    }
                } finally {
                    this.isAnalyzing = false;
                }
            },

            async compressImage(dataUrl) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > CONFIG.IMAGE_MAX_WIDTH || height > CONFIG.IMAGE_MAX_HEIGHT) {
                            const ratio = Math.min(CONFIG.IMAGE_MAX_WIDTH / width, CONFIG.IMAGE_MAX_HEIGHT / height);
                            width *= ratio;
                            height *= ratio;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        // ç°åº¦åŒ–å¤„ç†
                        ctx.drawImage(img, 0, 0, width, height);
                        const imageData = ctx.getImageData(0, 0, width, height);
                        const data = imageData.data;
                        for (let i = 0; i < data.length; i += 4) {
                            const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                            data[i] = data[i + 1] = data[i + 2] = gray;
                        }
                        ctx.putImageData(imageData, 0, 0);

                        resolve(canvas.toDataURL('image/jpeg', CONFIG.IMAGE_QUALITY));
                    };
                    img.src = dataUrl;
                });
            },

            async callAPI(text, retries = 0) {
                try {
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), CONFIG.API_TIMEOUT);

                    const response = await fetch(CONFIG.API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: CONFIG.MODEL,
                            messages: [{
                                role: 'user',
                                content: `åˆ†æè¿™ä¸ªé£Ÿå“çš„å¥åº·ç¨‹åº¦ï¼Œè¿”å› JSONï¼š${text}\n\nè¿”å›æ ¼å¼ï¼š{"score":0-100,"level":"ä¼˜ç§€/è‰¯å¥½/ä¸€èˆ¬/è¾ƒå·®/å¾ˆå·®","ingredients":[{"name":"é…æ–™","risk":0-5,"description":"æè¿°"}],"nutrition":{"energy":"å€¼","protein":"å€¼","fat":"å€¼","carbs":"å€¼","sodium":"å€¼"},"advice":["å»ºè®®1","å»ºè®®2"]}`
                            }],
                            temperature: 0.5,
                            max_tokens: 1000
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeout);

                    if (!response.ok) {
                        if (response.status === 401) throw new Error('API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ');
                        if (response.status === 429) throw new Error('API è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•');
                        throw new Error(`API é”™è¯¯: ${response.status}`);
                    }

                    const data = await response.json();
                    if (!data.choices || !data.choices[0]) throw new Error('API è¿”å›æ ¼å¼é”™è¯¯');

                    const content = data.choices[0].message.content;
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error('æ— æ³•è§£æ API è¿”å›çš„ JSON');

                    try {
                        return JSON.parse(jsonMatch[0]);
                    } catch (e) {
                        throw new Error('JSON è§£æå¤±è´¥: ' + e.message);
                    }
                } catch (e) {
                    if (e.name === 'AbortError') {
                        throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                    if (retries < CONFIG.MAX_RETRIES) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, retries) * 1000));
                        return this.callAPI(text, retries + 1);
                    }
                    throw e;
                }
            },

            showResults(analysis) {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');

                this.currentAnalysis = analysis;

                document.getElementById('scoreNumber').textContent = analysis.score || 0;
                document.getElementById('scoreLevel').textContent = analysis.level || 'æœªçŸ¥';

                const ingHtml = (analysis.ingredients || []).map(i =>
                    `<span class="ingredient-tag risk-${i.risk || 0}">${i.name} <small>${i.risk}/5</small></span>`
                ).join('');
                document.getElementById('ingredientsList').innerHTML = ingHtml || 'æ— ';

                const nut = analysis.nutrition || {};
                const nutHtml = `
                    <div style="padding: 12px; background: #ECFDF5; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: #6B7280;">èƒ½é‡</div>
                        <div style="font-size: 16px; font-weight: 700;">${nut.energy || '-'}</div>
                    </div>
                    <div style="padding: 12px; background: #FFFBEB; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: #6B7280;">è›‹ç™½è´¨</div>
                        <div style="font-size: 16px; font-weight: 700;">${nut.protein || '-'}</div>
                    </div>
                    <div style="padding: 12px; background: #FFFBEB; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: #6B7280;">è„‚è‚ª</div>
                        <div style="font-size: 16px; font-weight: 700;">${nut.fat || '-'}</div>
                    </div>
                    <div style="padding: 12px; background: #FFFBEB; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: #6B7280;">ç¢³æ°´</div>
                        <div style="font-size: 16px; font-weight: 700;">${nut.carbs || '-'}</div>
                    </div>
                `;
                document.getElementById('nutritionGrid').innerHTML = nutHtml;

                const adviceHtml = (analysis.advice || []).map(a =>
                    `<li style="padding: 12px; background: #ECFDF5; border-left: 4px solid var(--primary); border-radius: 4px;">${a}</li>`
                ).join('');
                document.getElementById('adviceList').innerHTML = adviceHtml || '<li>æ— å»ºè®®</li>';

                this.addToHistory(analysis);
            },

            showError(message) {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('errorSection').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('previewSection').classList.remove('hidden');
            },

            addToHistory(analysis) {
                this.history.unshift({
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    ...analysis
                });
                if (this.history.length > 100) this.history.pop();
                this.saveData();
            },

            renderHistory() {
                const search = document.getElementById('historySearch').value.toLowerCase();
                const filtered = this.history.filter(h =>
                    (h.level || '').toLowerCase().includes(search)
                );

                if (filtered.length === 0) {
                    document.getElementById('historyList').innerHTML = '<li style="text-align: center; color: #6B7280; padding: 20px;">æš‚æ— è®°å½•</li>';
                    return;
                }

                const html = filtered.map(item => `
                    <li style="padding: 12px; background: var(--gray-100); border-radius: 8px; cursor: pointer; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;" onclick="app.viewHistory(${item.id})">
                        <div>
                            <div style="font-weight: 600;">${item.level || 'æœªçŸ¥'}</div>
                            <div style="font-size: 12px; color: #6B7280;">${new Date(item.timestamp).toLocaleDateString()}</div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${item.score || 0}</div>
                    </li>
                `).join('');
                document.getElementById('historyList').innerHTML = html;
            },

            viewHistory(id) {
                const item = this.history.find(h => h.id === id);
                if (item) {
                    this.currentAnalysis = item;
                    this.showResults(item);
                    document.querySelector('[data-tab="scan"]').click();
                }
            },

            share() {
                if (!this.currentAnalysis) return;
                const text = `æˆ‘çš„é£Ÿå“åˆ†æç»“æœï¼š\nè¯„åˆ†: ${this.currentAnalysis.score}/100\nç­‰çº§: ${this.currentAnalysis.level}\n\nä½¿ç”¨"æ™ºé£Ÿé‰´"åº”ç”¨åˆ†æä½ çš„é£Ÿå“å¥åº·ç¨‹åº¦`;
                if (navigator.share) {
                    navigator.share({ title: 'æ™ºé£Ÿé‰´', text });
                } else {
                    alert(text);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
