# 智食鉴 V2 架构设计文档

## 核心设计理念

**充分利用 DeepSeek API 的强大能力，而不是依赖手写的小数据库**

### 三层处理流程

```
用户上传图片
    ↓
[第一层] Tesseract.js 初步 OCR 识别
    ↓ (原始文本可能有错误)
[第二层] DeepSeek API 纠正和优化 OCR 结果
    ↓ (获得准确的配料表和营养成分)
[第三层] DeepSeek API 进行完整分析
    ├─ 配料风险评估（调用内部知识库）
    ├─ 营养成分分析
    ├─ 健康评分计算
    └─ 个性化建议生成
    ↓
展示完整的分析结果
```

## API 调用策略

### 1. OCR 纠正阶段
**Prompt 设计：**
```
用户提供的 OCR 文本可能存在识别错误。请帮我纠正以下食品包装上的 OCR 识别结果：

[OCR 原始文本]

请返回 JSON 格式，包含：
{
  "corrected_text": "纠正后的完整文本",
  "ingredients": ["配料1", "配料2", ...],
  "nutrition_facts": {
    "energy": "能量值（kcal）",
    "protein": "蛋白质（g）",
    "fat": "脂肪（g）",
    "carbohydrate": "碳水化合物（g）",
    "sodium": "钠（mg）",
    "sugar": "糖（g）"
  },
  "confidence": 0.95  // 置信度 0-1
}
```

### 2. 完整分析阶段
**Prompt 设计：**
```
请对以下食品进行完整的健康分析：

配料表：[配料列表]
营养成分：[营养数据]

请返回 JSON 格式的完整分析报告：
{
  "health_score": 75,  // 0-100
  "score_level": "良好",
  "ingredients_analysis": [
    {
      "name": "配料名",
      "risk_level": 2,  // 0-5
      "risk_description": "风险描述",
      "health_impact": "对健康的影响"
    }
  ],
  "nutrition_analysis": {
    "calories_assessment": "热量评估",
    "sodium_assessment": "钠含量评估",
    "sugar_assessment": "糖含量评估",
    "fat_assessment": "脂肪评估",
    "protein_assessment": "蛋白质评估"
  },
  "health_warnings": ["警告1", "警告2"],
  "recommendations": ["建议1", "建议2", "建议3"],
  "suitable_for": ["适合人群1", "适合人群2"],
  "not_suitable_for": ["不适合人群1", "不适合人群2"]
}
```

## 数据缓存策略

为了提高性能和降低 API 成本，使用多层缓存：

### 1. 配料缓存 (IndexedDB)
- 存储已分析过的配料及其风险等级
- 避免重复调用 API 分析相同配料
- 定期更新（每月）

### 2. 食品缓存 (LocalStorage)
- 存储用户最近分析过的食品
- 快速查询历史记录
- 支持对比分析

### 3. 会话缓存 (内存)
- 当前会话中的临时数据
- 加快同一会话内的多次查询

## 功能完整性清单

### 核心功能
- [x] OCR 识别 + AI 纠正
- [x] 配料风险分析（由 API 提供）
- [x] 营养成分分析
- [x] 健康评分（0-100）
- [x] 个性化建议

### 扩展功能
- [x] 扫描历史记录
- [x] 食品对比分析
- [x] 健康报告导出
- [x] 收藏夹管理
- [x] 搜索功能
- [x] 数据统计

### 用户体验
- [x] 实时进度显示
- [x] 错误恢复机制
- [x] 离线模式支持
- [x] 响应式设计
- [x] 深色/浅色主题

## 技术栈

| 技术 | 用途 | 原因 |
|------|------|------|
| Tesseract.js | 初步 OCR | 快速本地识别 |
| DeepSeek API | 核心分析引擎 | 强大的 AI 能力 |
| IndexedDB | 配料数据缓存 | 大容量本地存储 |
| LocalStorage | 用户数据持久化 | 简单易用 |
| Chart.js | 数据可视化 | 轻量级图表库 |

## 性能目标

- 首次加载：< 3 秒
- OCR 识别：< 10 秒
- API 分析：< 5 秒
- 总分析时间：< 20 秒
- 缓存命中率：> 80%

## 错误处理

- 网络错误自动重试（最多 3 次）
- OCR 失败时提示用户手动输入
- API 超时时使用缓存数据
- 用户可随时取消操作

## 安全性

- API Key 本地存储，不上传服务器
- 图片仅在本地处理，不保存
- 所有敏感数据加密存储
- 定期清理过期缓存
